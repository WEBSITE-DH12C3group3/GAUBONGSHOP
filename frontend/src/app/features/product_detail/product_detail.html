<div class="product-detail-container" *ngIf="product() as p">
  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a routerLink="/">Trang chủ</a>
    <i class="fas fa-chevron-right"></i>
    <a routerLink="/categories/{{ p.categoryId }}">{{ p.categoryName }}</a>
    <i class="fas fa-chevron-right"></i>
    <span>{{ p.name }}</span>
  </nav>

  <div class="product-main">
    <!-- Hình ảnh -->
    <div class="product-gallery">
      <div class="product-badge" *ngIf="p.discountPercent > 0">GIẢM {{ p.discountPercent }}%</div>
      <div class="main-image-container">
        <img [src]="'http://localhost:8080' + p.imageUrl" [alt]="p.name" class="main-image" />
      </div>
      <div class="thumbnail-list">
        <div class="thumbnail-item active">
          <img [src]="'http://localhost:8080' + p.imageUrl" [alt]="p.name" />
        </div>
        <!-- Có thể thêm các thumbnail khác nếu có -->
      </div>
    </div>

    <!-- Thông tin -->
    <div class="product-info">
      <h1 class="product-title">{{ p.name }}</h1>

      <div class="rating-container">
        <div class="rating-stars">
          <i class="fas fa-star" *ngFor="let star of getStars(p.avgRating || 0)"></i>
        </div>
        <span class="rating-value">{{ p.avgRating || 0 | number:'1.1-1' }}</span>
        <span class="rating-count">({{ p.totalReviews || 0 }} đánh giá)</span>
      </div>

      <div class="price-container">
        <div class="current-price">
          {{ calculateDiscountPrice(p.price, p.discountPercent) | number }}₫
          <span class="original-price" *ngIf="p.discountPercent > 0">{{ p.price | number }}₫</span>
          <span class="discount-percent" *ngIf="p.discountPercent > 0">-{{ p.discountPercent }}%</span>
        </div>
      </div>

      <div class="promotion-container" *ngIf="p.promotions && p.promotions.length > 0">
        <div class="promotion-title">
          <i class="fas fa-gift"></i>
          Khuyến mãi
        </div>
        <ul class="promotion-list">
          <li *ngFor="let promo of p.promotions">{{ promo }}</li>
        </ul>
      </div>

      <div class="meta">
        <p><strong>Thương hiệu:</strong> {{ p.brandName }}</p>
        <p><strong>Danh mục:</strong> {{ p.categoryName }}</p>
        <p><strong>Mã sản phẩm:</strong> SP-{{ p.id }}</p>
      </div>

      <div class="quantity-container">
        <div class="quantity-title">Số lượng:</div>
        <div class="quantity-control">
          <button class="quantity-btn" (click)="decreaseQuantity()">-</button>
          <input type="number" class="quantity-input" [value]="quantity" min="1" [max]="p.stock" readonly>
          <button class="quantity-btn" (click)="increaseQuantity()">+</button>
        </div>
        <div class="stock-status" [class.in-stock]="p.stock > 0" [class.out-of-stock]="p.stock === 0">
          {{ p.stock > 0 ? 'Còn ' + p.stock + ' sản phẩm' : 'Hết hàng' }}
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-add-cart" (click)="addToCart(p)" [disabled]="p.stock === 0">
          <i class="fas fa-shopping-cart"></i>
          Thêm vào giỏ
        </button>
        <button class="btn btn-buy-now" [disabled]="p.stock === 0">Mua ngay</button>
      </div>

      <div class="delivery-info">
        <div class="delivery-title">Giao hàng:</div>
        <div class="delivery-options">
          <div class="delivery-option">
            <i class="fas fa-truck"></i>
            <span>Giao hàng nhanh trong 2 giờ</span>
          </div>
          <div class="delivery-option">
            <i class="fas fa-store"></i>
            <span>Nhận tại cửa hàng</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="product-tabs">
    <div class="tabs-header">
      <button (click)="setActiveTab('desc')" [class.active]="activeTab==='desc'" class="tab-button">Mô tả sản phẩm</button>
      <button (click)="setActiveTab('attr')" [class.active]="activeTab==='attr'" class="tab-button">Thông số kỹ thuật</button>
      <button (click)="setActiveTab('review')" [class.active]="activeTab==='review'" class="tab-button">Đánh giá ({{ p.totalReviews || 0 }})</button>
    </div>

    <div class="tab-content">
      <div class="tab-pane" [class.active]="activeTab==='desc'">
        <div class="description-content">
          <p>{{ p.description }}</p>
        </div>
      </div>

      <div class="tab-pane" [class.active]="activeTab==='attr'">
        <table class="attributes-table">
          <tr *ngFor="let a of p.attributes">
            <th>{{ a.attributeName }}:</th>
            <td>{{ a.value }}</td>
          </tr>
        </table>
      </div>

      <div class="tab-pane" [class.active]="activeTab==='review'">
        <div class="reviews-container">
          <div *ngFor="let r of reviews" class="review-item">
            <div class="review-avatar">
              {{ r.userName ? (r.userName | slice:0:1 | uppercase) : '?' }}
            </div>
            <div class="review-content">
              <div class="review-header">
                <div class="review-author">{{ r.userName }}</div>
                <div class="review-rating">
                  <i class="fas fa-star" *ngFor="let star of getStars(r.rating)"></i>
                </div>
              </div>
              <div class="review-date">{{ r.createdAt | date:'dd/MM/yyyy' }}</div>
              <p class="review-text">{{ r.comment }}</p>
            </div>
          </div>

          <div *ngIf="reviews.length === 0" class="no-reviews">
            Chưa có đánh giá nào cho sản phẩm này.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Sản phẩm liên quan -->
  <div class="related-products" *ngIf="related && related.length > 0">
    <h2 class="section-title">Sản phẩm liên quan</h2>
    <div class="related-grid">
      <div *ngFor="let rp of related" class="product-card" routerLink="/products/{{ rp.id }}">
        <img [src]="'http://localhost:8080' + rp.imageUrl" [alt]="rp.name" class="product-card-image" />
        <div class="product-card-body">
          <h3 class="product-card-title">{{ rp.name }}</h3>
          <div class="product-card-price">
            <span class="product-card-current">{{ calculateDiscountPrice(rp.price, rp.discountPercent) | number }}₫</span>
            <span class="product-card-original" *ngIf="rp.discountPercent > 0">{{ rp.price | number }}₫</span>
          </div>
          <div class="product-card-rating">
            <i class="fas fa-star"></i>
            <span>{{ rp.avgRating || 0 | number:'1.1-1' }} ({{ rp.totalReviews || 0 }})</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!product()" class="loading-container">
  <div class="loading-spinner"></div>
  <p>Đang tải thông tin sản phẩm...</p>
</div>