<div class="max-w-7xl mx-auto px-4 py-6" *ngIf="product() as p; else loading">
  <!-- Breadcrumb -->
  <nav class="flex items-center text-sm text-gray-500 space-x-2 mb-6">
    <a routerLink="/" class="hover:text-blue-600 transition">Trang chủ</a>
    <span>/</span>
    <span>{{ p.categoryName }}</span>
    <span>/</span>
    <span class="text-gray-900 font-medium">{{ p.name }}</span>
  </nav>

  <!-- Product -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden md:flex md:space-x-6">
    <!-- Gallery -->
    <div class="md:w-5/12 p-6">
      <div class="relative group rounded-lg overflow-hidden border">
        <!-- ✅ gắn template ref để fly-to-cart dùng ảnh nguồn -->
        <img #detailImg [src]="'http://localhost:8080' + p.imageUrl" [alt]="p.name"
             class="w-full h-96 object-contain transition-transform duration-300 group-hover:scale-105" />
        <span *ngIf="p.discountPercent && p.discountPercent > 0" class="line-through text-gray-400">
          {{ p.price | number }}₫
        </span>
      </div>

      <!-- Thumbnail -->
      <div class="flex gap-3 mt-4">
        <div class="w-16 h-16 border rounded-md overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-500">
          <img [src]="'http://localhost:8080' + p.imageUrl" [alt]="p.name" class="w-full h-full object-cover" />
        </div>
      </div>
    </div>

    <!-- Info -->
    <div class="md:w-7/12 p-6 space-y-4">
      <h1 class="text-2xl font-semibold text-gray-900">{{ p.name }}</h1>

      <!-- Rating -->
      <div class="flex items-center space-x-2">
        <div class="flex text-yellow-400">
          <i class="fas fa-star" *ngFor="let s of getStars(p.avgRating || 0)"></i>
        </div>
        <span class="text-gray-600 text-sm">({{ p.totalReviews || 0 }} đánh giá)</span>
      </div>

      <!-- Price -->
      <div class="flex items-center space-x-3">
        <ng-container *ngIf="(p.discountPercent || 0) > 0; else noDiscount">
          <span class="text-2xl font-bold text-red-600">
            {{ calculateDiscountPrice(p.price, p.discountPercent || 0) | number }}₫
          </span>
          <span class="line-through text-gray-400">
            {{ p.price | number }}₫
          </span>
        </ng-container>
        <ng-template #noDiscount>
          <span class="text-2xl font-bold text-red-600">
            {{ p.price | number }}₫
          </span>
        </ng-template>
      </div>

      <!-- Meta -->
      <div class="text-sm text-gray-600 space-y-1">
        <p><strong>Thương hiệu:</strong> {{ p.brandName || 'Đang cập nhật' }}</p>
        <p><strong>Danh mục:</strong> {{ p.categoryName || 'Đang cập nhật' }}</p>
        <p><strong>Mã sản phẩm:</strong> SP-{{ p.id }}</p>
      </div>

      <!-- Quantity -->
      <div class="flex items-center space-x-4">
        <span class="font-medium">Số lượng:</span>
        <div class="flex items-center border rounded-lg">
          <button (click)="decreaseQuantity()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200">-</button>
          <input type="number" [value]="quantity" readonly class="w-12 text-center border-x font-medium" />
          <button (click)="increaseQuantity()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200">+</button>
        </div>
        <span [class.text-green-600]="p.stock>0" [class.text-red-500]="p.stock===0">
          {{ p.stock > 0 ? 'Còn ' + p.stock + ' sản phẩm' : 'Hết hàng' }}
        </span>
      </div>

      <!-- Actions -->
      <div class="flex gap-4">
        <!-- ✅ thêm vào giỏ: bay từ ảnh detail -->
        <button
          (click)="addToCart($event, detailImg)"
          class="flex-1 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium shadow transition disabled:opacity-50"
          [disabled]="p.stock===0">
          <i class="fas fa-cart-plus mr-2"></i> Thêm vào giỏ
        </button>

        <!-- ✅ mua ngay: add -> điều hướng /cart -->
        <button
          (click)="buyNow()"
          class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium shadow transition"
          [disabled]="p.stock===0">
          Mua ngay
        </button>

        <!-- Favorite Button -->
        <button (click)="toggleFavorite(p.id, $event)"
          class="w-12 h-12 rounded-full flex items-center justify-center shadow-md transition border"
          [ngClass]="isFavorite(p.id) 
            ? 'bg-red-500 text-white border-red-500' 
            : 'bg-white text-gray-600 border-gray-300'"
          title="Thêm vào yêu thích">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="bg-white rounded-lg shadow mt-8">
    <div class="flex border-b">
      <button (click)="setActiveTab('desc')" [class.text-blue-600]="activeTab==='desc'"
        class="flex-1 py-3 text-center font-medium hover:bg-gray-50">Mô tả</button>
      <button (click)="setActiveTab('attr')" [class.text-blue-600]="activeTab==='attr'"
        class="flex-1 py-3 text-center font-medium hover:bg-gray-50">Thông số</button>
      <button (click)="setActiveTab('review')" [class.text-blue-600]="activeTab==='review'"
        class="flex-1 py-3 text-center font-medium hover:bg-gray-50">
        Đánh giá ({{ p.totalReviews || 0 }})
      </button>
    </div>

    <div class="p-6">
      <!-- Mô tả -->
      <div *ngIf="activeTab==='desc'">
        <p class="text-gray-700 leading-relaxed">{{ p.description }}</p>
      </div>

      <!-- Attributes -->
      <div *ngIf="activeTab==='attr'">
        <table *ngIf="p.attributes && p.attributes.length > 0; else noAttr" class="w-full border divide-y text-sm">
          <tr *ngFor="let a of p.attributes" class="hover:bg-gray-50">
            <th class="p-3 text-gray-600 text-left w-1/3">{{ a.attributeName }}</th>
            <td>{{ a.value }}</td>
          </tr>
        </table>
        <ng-template #noAttr>
          <p class="text-gray-500 italic">Chưa có thông số kỹ thuật.</p>
        </ng-template>
      </div>

      <!-- Reviews -->
      <div *ngIf="activeTab==='review'">
        <div *ngIf="reviews.length>0; else noReview" class="space-y-6">
          <div *ngFor="let r of reviews" class="border-b pb-4">
            <div class="flex justify-between">
              <span class="font-medium">{{ r.userName || 'Ẩn danh' }}</span>
              <span class="text-yellow-400">
                <i class="fas fa-star" *ngFor="let s of getStars(r.rating)"></i>
              </span>
            </div>
            <p class="text-gray-600 text-sm">{{ r.createdAt | date:'dd/MM/yyyy' }}</p>
            <p class="mt-2 text-gray-800">{{ r.comment }}</p>
          </div>
        </div>
        <ng-template #noReview>
          <p class="text-gray-500 italic">Chưa có đánh giá nào cho sản phẩm này.</p>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Related Products -->
  <div class="mt-10" *ngIf="related.length>0">
    <h2 class="text-lg font-semibold mb-4">Sản phẩm liên quan</h2>
    <div class="grid md:grid-cols-4 sm:grid-cols-2 gap-6">
      <div *ngFor="let rp of related" [routerLink]="['/products', rp.id]"
        class="bg-white rounded-lg shadow hover:shadow-lg cursor-pointer transition transform hover:-translate-y-1">
        <img [src]="'http://localhost:8080' + rp.imageUrl" [alt]="rp.name" class="w-full h-48 object-contain p-3" />
        <div class="p-3">
          <h3 class="text-sm font-medium line-clamp-2">{{ rp.name }}</h3>
          <div class="text-red-500 font-semibold">
            {{ calculateDiscountPrice(rp.price, rp.discountPercent || 0) | number }}₫
          </div>
          <div *ngIf="(rp.discountPercent ?? 0) > 0" class="text-gray-400 line-through text-sm">
            {{ rp.price | number }}₫
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<ng-template #loading>
  <div class="flex flex-col items-center justify-center h-64 text-gray-500">
    <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-3">Đang tải sản phẩm...</p>
  </div>
</ng-template>
